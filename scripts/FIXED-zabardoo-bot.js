const TelegramBot = require('node-telegram-bot-api');

// Bot configuration
const token = process.env.TELEGRAM_BOT_TOKEN || 'YOUR_BOT_TOKEN_HERE';
const bot = new TelegramBot(token, { polling: true });

// INLINE KEYBOARD - –í–ï–†–•–ù–ò–ï –ö–ù–û–ü–ö–ò (—Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
const inlineMainMenu = {
  inline_keyboard: [
    [
      { text: 'üîç Find Deals', callback_data: 'find_deals' },
      { text: 'üéÆ My Profile', callback_data: 'my_profile' },
      { text: 'üìñ Guide', callback_data: 'guide' }
    ],
    [
      { text: 'üí∞ Cashback', callback_data: 'cashback' },
      { text: 'üé≤ Random Deal', callback_data: 'random_deal' },
      { text: 'üí¨ Ask bazaarGuru', callback_data: 'ask_bazaarGuru' }
    ],
    [
      { text: '‚öôÔ∏è Settings', callback_data: 'settings' },
      { text: 'üåê Language', callback_data: 'language' },
      { text: 'üÜò Help', callback_data: 'help' }
    ]
  ]
};

// REPLY KEYBOARD - –ù–ò–ñ–ù–ò–ï –ö–ù–û–ü–ö–ò
const replyKeyboard = {
  keyboard: [
    ['üîç Find Deals', 'üéÆ My Profile', 'üìñ Guide'],
    ['üí∞ Cashback', 'üé≤ Random Deal', 'üí¨ Ask bazaarGuru'],
    ['‚öôÔ∏è Settings', 'üåê Language', 'üÜò Help']
  ],
  resize_keyboard: true,
  one_time_keyboard: false
};

// Bot commands
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const firstName = msg.from.first_name || 'Friend';
  
  const welcomeMessage = `üéâ Welcome to bazaarGuru Enhanced Bot, ${firstName}! üåü

üöÄ I'm your AI-powered deal discovery assistant!

üéØ What I can do for you:
üé§ Voice Search - Send me a voice message! (Try: "bottle", "headphones")
üì∏ Image Recognition - Send me a product photo! (Just tap and send)
üéÆ Gamification - Earn XP and unlock achievements!
‚ö†Ô∏è Smart Notifications - Get personalized deal alerts!
üí∞ Cashback Tracking - Track your savings!

üíé Level 1 ‚Ä¢ ‚ö° 0 XP ‚Ä¢ üèÜ 0/50 Achievements

üéÆ Today's Mission: Find your first amazing deal!

üîßüì∏ QUICK START: Send voice message or photo right now for instant deals!

Ready to save some serious money? Let's go! üöÄ

üí° Tip: Click üìñ Guide button for complete instructions on all buttons!`;

  // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –° INLINE –ö–ù–û–ü–ö–ê–ú–ò
  await bot.sendMessage(chatId, welcomeMessage, {
    parse_mode: 'Markdown',
    reply_markup: inlineMainMenu
  });
  
  // –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú REPLY KEYBOARD
  await bot.sendMessage(chatId, 'üí° Both upper and lower menus work the same!', {
    reply_markup: replyKeyboard
  });
});

// Handle callback queries (–í–ï–†–•–ù–ò–ï –ö–ù–û–ü–ö–ò - —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
bot.on('callback_query', async (callbackQuery) => {
  const message = callbackQuery.message;
  const chatId = message.chat.id;
  const data = callbackQuery.data;

  await bot.answerCallbackQuery(callbackQuery.id);

  console.log(`‚úÖ UPPER button pressed: ${data}`);

  try {
    switch (data) {
      case 'find_deals':
        await bot.sendMessage(chatId, `üîç *Find Deals*

üí° *How to search:*

1Ô∏è‚É£ **Type product name**
   Example: "iPhone", "Nike shoes", "laptop"

2Ô∏è‚É£ **Use voice search**
   Send a voice message with product name

3Ô∏è‚É£ **Send product photo**
   Take a picture of the product you want

üî• **Popular searches:**
‚Ä¢ Smartphones under ‚Çπ20,000
‚Ä¢ Wireless earbuds
‚Ä¢ Running shoes
‚Ä¢ Skincare products
‚Ä¢ Gaming laptops

üí∞ **What you'll get:**
‚Ä¢ Real-time prices from multiple stores
‚Ä¢ Discount percentages and savings
‚Ä¢ Cashback rates for each store
‚Ä¢ Direct purchase links

Just type what you're looking for! üõçÔ∏è`, { parse_mode: 'Markdown' });
        break;
      
      case 'my_profile':
        await bot.sendMessage(chatId, `üéÆ *My Profile*

üë§ **User Stats:**
‚Ä¢ Total Searches: 47
‚Ä¢ Money Saved: ‚Çπ12,450
‚Ä¢ Cashback Earned: ‚Çπ890
‚Ä¢ Favorite Categories: Electronics, Fashion

üìä **Activity Summary:**
‚Ä¢ This Month: 15 searches
‚Ä¢ Best Deal Found: 45% OFF Nike shoes
‚Ä¢ Top Store: Flipkart (12 purchases)
‚Ä¢ Average Savings: 28% per purchase

üèÜ **Achievements:**
‚Ä¢ ü•â Smart Shopper (10+ purchases)
‚Ä¢ üí∞ Deal Hunter (‚Çπ10k+ saved)
‚Ä¢ üéÅ Cashback Master (‚Çπ500+ earned)
‚Ä¢ üîç Search Expert (50+ searches)

Keep shopping to unlock more rewards! üåü`, { parse_mode: 'Markdown' });
        break;
      
      case 'guide':
        await bot.sendMessage(chatId, `üìñ *bazaarGuru Shopping Guide*

üõçÔ∏è *How to Shop Smart:*

1Ô∏è‚É£ *Search Products:*
   ‚Ä¢ Use "üîç Find Deals" button
   ‚Ä¢ Tap category buttons (üì±üëóüíÑ)
   ‚Ä¢ Type product names directly

2Ô∏è‚É£ *Compare Prices:*
   ‚Ä¢ See original vs discounted price
   ‚Ä¢ Check cashback rates
   ‚Ä¢ Compare across stores

3Ô∏è‚É£ *Use Menu Features:*
   ‚Ä¢ üî• Hot Deals - trending offers
   ‚Ä¢ ü§ñ AI Recommendations - personalized
   ‚Ä¢ üè™ Stores - browse by shop
   ‚Ä¢ üí∞ Cashback - earn money back

4Ô∏è‚É£ *Track Your Activity:*
   ‚Ä¢ üéÆ My Profile - view stats
   ‚Ä¢ ‚öôÔ∏è Settings - customize experience
   ‚Ä¢ üÜò Help - get support

üí° *Pro Tips:*
‚Ä¢ Use both inline buttons (in messages) and bottom menu
‚Ä¢ Send voice messages for quick search
‚Ä¢ Upload product photos for recognition

Ready to start shopping? üöÄ`, { parse_mode: 'Markdown' });
        break;
      
      case 'cashback':
        await bot.sendMessage(chatId, `üí∞ *Cashback Center*

üí≥ **Current Rates:**
‚Ä¢ Flipkart: 2-8% cashback
‚Ä¢ Amazon India: 1-6% cashback
‚Ä¢ Myntra: 3-10% cashback
‚Ä¢ Nykaa: 5-12% cashback
‚Ä¢ AJIO: 4-9% cashback

üìä **Your Cashback:**
‚Ä¢ This Month: ‚Çπ245
‚Ä¢ Total Earned: ‚Çπ890
‚Ä¢ Pending: ‚Çπ67
‚Ä¢ Available for Withdrawal: ‚Çπ823

üí° **Maximize Cashback:**
‚Ä¢ Use recommended payment methods
‚Ä¢ Shop during special events
‚Ä¢ Combine with coupon codes

Ready to earn more cashback? üíé`, { parse_mode: 'Markdown' });
        break;
      
      case 'random_deal':
        await bot.sendMessage(chatId, `üé≤ *Random Deal of the Day!*

üéÅ Special surprise offer!

‚Ä¢ Samsung Galaxy Buds - 40% OFF (‚Çπ8,999)
‚Ä¢ Limited time offer
‚Ä¢ Free shipping included
‚Ä¢ 1 year warranty

üîó Grab this deal now!`, { parse_mode: 'Markdown' });
        break;
      
      case 'ask_bazaarGuru':
        await bot.sendMessage(chatId, `üí¨ *Ask bazaarGuru*

ü§ñ I'm here to help you with:

‚ùì **Product Questions:**
‚Ä¢ "What's the best smartphone under ‚Çπ30,000?"
‚Ä¢ "Show me wireless earbuds with good battery"
‚Ä¢ "Find me running shoes for women"

üí∞ **Deal Questions:**
‚Ä¢ "Any deals on laptops today?"
‚Ä¢ "What's the highest cashback store?"
‚Ä¢ "Show me electronics with 50% off"

üè™ **Store Questions:**
‚Ä¢ "Which store has fastest delivery?"
‚Ä¢ "Compare prices for iPhone 15"
‚Ä¢ "Best store for fashion items?"

Just type your question and I'll help you find the perfect deal! üõçÔ∏è`, { parse_mode: 'Markdown' });
        break;
      
      case 'settings':
        await bot.sendMessage(chatId, `‚öôÔ∏è *Settings*

üåê *Language:* English
üîî *Notifications:* Enabled
üí∞ *Price Alerts:* Enabled
üìç *Location:* India

üõçÔ∏è *Shopping Preferences:*
‚Ä¢ Show cashback rates: ‚úÖ
‚Ä¢ Include out-of-stock items: ‚ùå
‚Ä¢ Sort by: Best Discount
‚Ä¢ Max results per search: 10

üîê *Privacy:*
‚Ä¢ Save search history: ‚úÖ
‚Ä¢ Personalized recommendations: ‚úÖ
‚Ä¢ Share usage data: ‚ùå

To change any setting, just tell me what you'd like to modify!`, { parse_mode: 'Markdown' });
        break;
      
      case 'language':
        await bot.sendMessage(chatId, `üåê *Language Settings*

üáÆüá≥ **Available Languages:**
‚Ä¢ English (Current) ‚úÖ
‚Ä¢ ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)
‚Ä¢ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)
‚Ä¢ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)
‚Ä¢ ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)
‚Ä¢ ‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)
‚Ä¢ ‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)
‚Ä¢ ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)
‚Ä¢ ‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)

üí° **Language Features:**
‚Ä¢ Product names in local language
‚Ä¢ Currency in Indian Rupees (‚Çπ)
‚Ä¢ Local store preferences
‚Ä¢ Regional deal notifications

Current: English üá¨üáß

Which language would you like to switch to?`, { parse_mode: 'Markdown' });
        break;
      
      case 'help':
        await bot.sendMessage(chatId, `üÜò *Help & Support*

üîß **Quick Help:**

‚ùì **How to use the bot:**
‚Ä¢ Use menu buttons for different features
‚Ä¢ Type product names to search
‚Ä¢ Send voice messages for quick search
‚Ä¢ Upload product photos for recognition

üõçÔ∏è **Shopping Help:**
‚Ä¢ üîç Find Deals - search any product
‚Ä¢ üé≤ Random Deal - discover surprise offers
‚Ä¢ üí¨ Ask bazaarGuru - get shopping advice
‚Ä¢ üí∞ Cashback - track your earnings

üìû **Contact Support:**
‚Ä¢ Report bugs or issues
‚Ä¢ Suggest new features
‚Ä¢ Get shopping advice
‚Ä¢ Technical assistance

üí° **Tips:**
‚Ä¢ Both upper and lower menus work the same
‚Ä¢ All menu buttons have specific functions
‚Ä¢ Voice search is faster than typing

Need more help? Just ask! üòä`, { parse_mode: 'Markdown' });
        break;
      
      default:
        await bot.sendMessage(chatId, `‚ùì Unknown inline button: ${data}`);
    }
  } catch (error) {
    console.error('Error handling callback query:', error);
    await bot.sendMessage(chatId, '‚ùå Sorry, something went wrong with upper button.');
  }
});

// Handle text messages (–ù–ò–ñ–ù–ò–ï –ö–ù–û–ü–ö–ò - –ò–°–ü–†–ê–í–õ–ï–ù–û!)
bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;

  if (!text || text.startsWith('/')) return;

  console.log(`üîç LOWER button pressed: "${text}"`);

  try {
    // –ò–°–ü–û–õ–¨–ó–£–ï–ú –¢–ï –ñ–ï –§–£–ù–ö–¶–ò–ò –ß–¢–û –ò –í–ï–†–•–ù–ò–ï –ö–ù–û–ü–ö–ò
    switch (text) {
      case 'üîç Find Deals':
        console.log('‚úÖ Calling Find Deals for lower button');
        await bot.sendMessage(chatId, `üîç *Find Deals*

üí° *How to search:*

1Ô∏è‚É£ **Type product name**
   Example: "iPhone", "Nike shoes", "laptop"

2Ô∏è‚É£ **Use voice search**
   Send a voice message with product name

3Ô∏è‚É£ **Send product photo**
   Take a picture of the product you want

üî• **Popular searches:**
‚Ä¢ Smartphones under ‚Çπ20,000
‚Ä¢ Wireless earbuds
‚Ä¢ Running shoes
‚Ä¢ Skincare products
‚Ä¢ Gaming laptops

üí∞ **What you'll get:**
‚Ä¢ Real-time prices from multiple stores
‚Ä¢ Discount percentages and savings
‚Ä¢ Cashback rates for each store
‚Ä¢ Direct purchase links

Just type what you're looking for! üõçÔ∏è`, { parse_mode: 'Markdown' });
        break;
      
      case 'üéÆ My Profile':
        console.log('‚úÖ Calling My Profile for lower button');
        await bot.sendMessage(chatId, `üéÆ *My Profile*

üë§ **User Stats:**
‚Ä¢ Total Searches: 47
‚Ä¢ Money Saved: ‚Çπ12,450
‚Ä¢ Cashback Earned: ‚Çπ890
‚Ä¢ Favorite Categories: Electronics, Fashion

üìä **Activity Summary:**
‚Ä¢ This Month: 15 searches
‚Ä¢ Best Deal Found: 45% OFF Nike shoes
‚Ä¢ Top Store: Flipkart (12 purchases)
‚Ä¢ Average Savings: 28% per purchase

üèÜ **Achievements:**
‚Ä¢ ü•â Smart Shopper (10+ purchases)
‚Ä¢ üí∞ Deal Hunter (‚Çπ10k+ saved)
‚Ä¢ üéÅ Cashback Master (‚Çπ500+ earned)
‚Ä¢ üîç Search Expert (50+ searches)

Keep shopping to unlock more rewards! üåü`, { parse_mode: 'Markdown' });
        break;
      
      case 'üìñ Guide':
        console.log('‚úÖ Calling Guide for lower button');
        await bot.sendMessage(chatId, `üìñ *bazaarGuru Shopping Guide*

üõçÔ∏è *How to Shop Smart:*

1Ô∏è‚É£ *Search Products:*
   ‚Ä¢ Use "üîç Find Deals" button
   ‚Ä¢ Tap category buttons (üì±üëóüíÑ)
   ‚Ä¢ Type product names directly

2Ô∏è‚É£ *Compare Prices:*
   ‚Ä¢ See original vs discounted price
   ‚Ä¢ Check cashback rates
   ‚Ä¢ Compare across stores

3Ô∏è‚É£ *Use Menu Features:*
   ‚Ä¢ üî• Hot Deals - trending offers
   ‚Ä¢ ü§ñ AI Recommendations - personalized
   ‚Ä¢ üè™ Stores - browse by shop
   ‚Ä¢ üí∞ Cashback - earn money back

4Ô∏è‚É£ *Track Your Activity:*
   ‚Ä¢ üéÆ My Profile - view stats
   ‚Ä¢ ‚öôÔ∏è Settings - customize experience
   ‚Ä¢ üÜò Help - get support

üí° *Pro Tips:*
‚Ä¢ Use both inline buttons (in messages) and bottom menu
‚Ä¢ Send voice messages for quick search
‚Ä¢ Upload product photos for recognition

Ready to start shopping? üöÄ`, { parse_mode: 'Markdown' });
        break;
      
      case 'üí∞ Cashback':
        console.log('‚úÖ Calling Cashback for lower button');
        await bot.sendMessage(chatId, `üí∞ *Cashback Center*

üí≥ **Current Rates:**
‚Ä¢ Flipkart: 2-8% cashback
‚Ä¢ Amazon India: 1-6% cashback
‚Ä¢ Myntra: 3-10% cashback
‚Ä¢ Nykaa: 5-12% cashback
‚Ä¢ AJIO: 4-9% cashback

üìä **Your Cashback:**
‚Ä¢ This Month: ‚Çπ245
‚Ä¢ Total Earned: ‚Çπ890
‚Ä¢ Pending: ‚Çπ67
‚Ä¢ Available for Withdrawal: ‚Çπ823

üí° **Maximize Cashback:**
‚Ä¢ Use recommended payment methods
‚Ä¢ Shop during special events
‚Ä¢ Combine with coupon codes

Ready to earn more cashback? üíé`, { parse_mode: 'Markdown' });
        break;
      
      case 'üé≤ Random Deal':
        console.log('‚úÖ Calling Random Deal for lower button');
        await bot.sendMessage(chatId, `üé≤ *Random Deal of the Day!*

üéÅ Special surprise offer!

‚Ä¢ Samsung Galaxy Buds - 40% OFF (‚Çπ8,999)
‚Ä¢ Limited time offer
‚Ä¢ Free shipping included
‚Ä¢ 1 year warranty

üîó Grab this deal now!`, { parse_mode: 'Markdown' });
        break;
      
      case 'üí¨ Ask bazaarGuru':
        console.log('‚úÖ Calling Ask bazaarGuru for lower button');
        await bot.sendMessage(chatId, `üí¨ *Ask bazaarGuru*

ü§ñ I'm here to help you with:

‚ùì **Product Questions:**
‚Ä¢ "What's the best smartphone under ‚Çπ30,000?"
‚Ä¢ "Show me wireless earbuds with good battery"
‚Ä¢ "Find me running shoes for women"

üí∞ **Deal Questions:**
‚Ä¢ "Any deals on laptops today?"
‚Ä¢ "What's the highest cashback store?"
‚Ä¢ "Show me electronics with 50% off"

üè™ **Store Questions:**
‚Ä¢ "Which store has fastest delivery?"
‚Ä¢ "Compare prices for iPhone 15"
‚Ä¢ "Best store for fashion items?"

Just type your question and I'll help you find the perfect deal! üõçÔ∏è`, { parse_mode: 'Markdown' });
        break;
      
      case '‚öôÔ∏è Settings':
        console.log('‚úÖ Calling Settings for lower button');
        await bot.sendMessage(chatId, `‚öôÔ∏è *Settings*

üåê *Language:* English
üîî *Notifications:* Enabled
üí∞ *Price Alerts:* Enabled
üìç *Location:* India

üõçÔ∏è *Shopping Preferences:*
‚Ä¢ Show cashback rates: ‚úÖ
‚Ä¢ Include out-of-stock items: ‚ùå
‚Ä¢ Sort by: Best Discount
‚Ä¢ Max results per search: 10

üîê *Privacy:*
‚Ä¢ Save search history: ‚úÖ
‚Ä¢ Personalized recommendations: ‚úÖ
‚Ä¢ Share usage data: ‚ùå

To change any setting, just tell me what you'd like to modify!`, { parse_mode: 'Markdown' });
        break;
      
      case 'üåê Language':
        console.log('‚úÖ Calling Language for lower button');
        await bot.sendMessage(chatId, `üåê *Language Settings*

üáÆüá≥ **Available Languages:**
‚Ä¢ English (Current) ‚úÖ
‚Ä¢ ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)
‚Ä¢ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)
‚Ä¢ ‡Æ§‡ÆÆ‡¶ø‡Æ¥‡Øç (Tamil)
‚Ä¢ ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)
‚Ä¢ ‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)
‚Ä¢ ‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)
‚Ä¢ ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)
‚Ä¢ ‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)

üí° **Language Features:**
‚Ä¢ Product names in local language
‚Ä¢ Currency in Indian Rupees (‚Çπ)
‚Ä¢ Local store preferences
‚Ä¢ Regional deal notifications

Current: English üá¨üáß

Which language would you like to switch to?`, { parse_mode: 'Markdown' });
        break;
      
      case 'üÜò Help':
        console.log('‚úÖ Calling Help for lower button');
        await bot.sendMessage(chatId, `üÜò *Help & Support*

üîß **Quick Help:**

‚ùì **How to use the bot:**
‚Ä¢ Use menu buttons for different features
‚Ä¢ Type product names to search
‚Ä¢ Send voice messages for quick search
‚Ä¢ Upload product photos for recognition

üõçÔ∏è **Shopping Help:**
‚Ä¢ üîç Find Deals - search any product
‚Ä¢ üé≤ Random Deal - discover surprise offers
‚Ä¢ üí¨ Ask bazaarGuru - get shopping advice
‚Ä¢ üí∞ Cashback - track your earnings

üìû **Contact Support:**
‚Ä¢ Report bugs or issues
‚Ä¢ Suggest new features
‚Ä¢ Get shopping advice
‚Ä¢ Technical assistance

üí° **Tips:**
‚Ä¢ Both upper and lower menus work the same
‚Ä¢ All menu buttons have specific functions
‚Ä¢ Voice search is faster than typing

Need more help? Just ask! üòä`, { parse_mode: 'Markdown' });
        break;
      
      default:
        // Handle product search –¢–û–õ–¨–ö–û –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        console.log(`‚ùå No case matched for: "${text}", treating as product search`);
        const userName = msg.from.first_name || 'Andre_web';
        const response = `üéØ Great message, ${userName}!

üîç I found some relevant deals for: "${text}"

üì± Top Results:
‚Ä¢ Samsung Galaxy S24 - 28% OFF (‚Çπ52,000)
‚Ä¢ iPhone 15 Pro - 15% OFF (‚Çπ1,20,000)
‚Ä¢ OnePlus 12 - 35% OFF (‚Çπ45,000)

üí∞ All with cashback up to 8%!
üéÅ +10 XP for searching!

üí° Pro tip: Try voice search or send me a product photo for better results!`;

        await bot.sendMessage(chatId, response);
        break;
    }
  } catch (error) {
    console.error('Error handling message:', error);
    await bot.sendMessage(chatId, '‚ùå Sorry, something went wrong with lower button.');
  }
});

// Error handling
bot.on('polling_error', (error) => {
  console.error('Polling error:', error);
});

console.log('üöÄ FIXED bazaarGuru Bot is running!');
console.log('‚úÖ UPPER buttons (inline) work correctly');
console.log('‚úÖ LOWER buttons (reply) now work correctly too!');
console.log('üéØ Test: Press "üìñ Guide" in lower menu - should show guide, not product search');
console.log('üìù Console logs will show which button was pressed');