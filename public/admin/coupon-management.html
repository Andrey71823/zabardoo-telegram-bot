<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupon Management Panel - Zabardoo Admin</>
    <link ht">
    <link h">
    <link href="https:">
    <style>
        .sidebar {
          100vh;
        00%);
        }
        .sidebar .nav-link {
            color: rgba(255,255,;
            padding: 0.75rem 1rem;
         m 0;
        m;
            trans;
        }
        .sidebar .nav-lin
            color: white;
            background-color: rgba(255,255,255,0.1)
        }
         {
            backgrou;
            min-height: 100vh;
        }
        .{
        
            border-5px;
            box-shadow: 0;
         
        }
        .card:hover {
            box-shadow: 0 0.5r5);
        }
        .stat-card {
         100%);
        
        }
        .stat-card-success {
            background: li 100%);
        }
        .stat-card-warning {
            background: linear-g 100%);
        }
        .stat-card-info {
            background: linear-g);
        }
        .btn-primary {
         100%);
        e;
        }
        .btn-primary:hover {
            background100%);
        }
        .dge {
        5rem;
            padding: 0.em;
        }
        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
        }
        {
            background: lineaa2 100%);
            color: white;
        }
        .{
        
            box-shadow: 0.25);
        }
        .loading {
            display: none;
        }
        .bulk-actions {
         9ecef;
        ;
            bom;
            margin-bottom: 1rem;
        }
        .filter-section {
            background-colorite;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0.125re);
        }
    </style>
</head>
<body>
    <div class="contaiid">
        <div class="row">
            <!-- Sidebar 
         
        
                    <div cla>
                        <h4 clas
         ll>
        iv>
                    <ucolumn">
                        <li clas
                         oard">
         </i>
        d
                            /a>
                        </li>
         >
        ">
                     </i>
                                ons
                          </a>
         </li>
        m">
                           
                                -2"></i>
         
         </a>
                        i>
                        <li clasem">
                         ">
         /i>
        ns
                            </a>
                        </li>
         >
        >
                 /i>
                              
                            >
         
        
                     >
                          >
                                Analytics
                      
                        </li>
         ul>
        
            </nav>

            <!-- Main contt -->
            <main class="col-md-
                <div class="d-flex justify-content->
                    <h1 class="h1>
         
        
                     ">
                           
                            </
                           ()">
                               sh
         /button>
        iv>
                    <
                </div>

         
        
                    <div4">
                        <div c
                            <div">
                                <div class="card-body">
                             center">
         
        iv>
                       
                                
                          
                                            <i>
                          /div>
                                    </div>
                                /div>
         v>
        >
                      
                            <cess">
                             
         >
        
                       
                          
                      >
                                
         /i>
        
                iv>
                        >
                            </div>
         iv>
        ">
                  >
                   
                               r">
                             -2">
                                            <v>
         v>
        
                   to">
                                ></i>
                             iv>
                        
         
        >
                        </div>
                        <div cla">
         rd-info">
        ">
                       >
                             2">
                                nue</div>
                            v>
                             div>
         -auto">
        2x"></i>
                         
                                
                           iv>
         
        v>
                    </div>

                    <!-- Reity -->
         ="row">
        lg-8">
                          card">
                                eader">
                           
         div>
        y">
                       
                                e">
                           ead>
         tr>
        
                         /th>
                                
                           d</th>
         /th>
        /tr>
                     head>
                          y>
                                    ere -->
                                y>
                      >
                          
         v>
        div>
                        </div>
                        <div clg-4">
                            <div classd">
                              >
                               5>
                            >
         ">
        
                                  >
                                v>
         v>
        
                        </div>
                    </div>
                </div>

         
        >
                -->
                    <div con">
                        <h5>>
                        <ds="row">
                    ">
                   >
                        ultiple>
                         ption>
                                    <opton>
         >
        /option>
                        
                              t>
                            >
                       ">
                                bel>
                       
                            <>
                            <
                             el>
         
        div>
                       >
                          
                                <input type="...">
                            </div>
                        </div>
                        <div cla>
         ">
        
                      
                            <
                            <
         >
        
                /div>
                            
                              
                            >
                        tion>
         
        on>
                      ption>
                        ion>
         lect>
          </div>
                     ">
                          /label>
         >
        /option>
                     n>
                                t>
         /div>
        /div>
                      mt-3">
                           2">
                               >
                             
                        utton>
         
        ers
                       /button>
                        >
                        </div>
                    </div>

                    <!-- Bul>
         
        er">
                            <">
                          lected
                            </div>
         ">
        group">
                   ">
                          ate
                                    </butto
                      vate')">
         ivate
        on>
                  ture')">
                               ure
                          ton>
                        )">
         e
        
                          >
                        v>
                        <
                    </div>

                    <!-- Coupon>
                    <div class="card">
                        <div clady">
         
        
                         
                                        <tr>
                                            <th
         
        
                th>
                                
                           
                          </th>
                               t</th>
                           </th>
         >
        </th>
                  >
                                >
                           
                          ad>
                               >
                           
         
        
                            </div>
                            
                            <!-- Pagination -->
                            <nav aria>
             >
            ->
                             ul>
                            </nav>
             
            
                </div>

              -->
            
                    <div "card">
                        <div class="card-header">
             /h5>
            >
                    y">
                            <div">
             
            head>
                       >
                                           >
             /th>
         th>
            th>
       >
      /th>
                        </th>
                                     >
                                    </thead>
          
>
                           
                        
                            <
                        </div>
                    </div>
                </div>

                <!-- Load
                <div class="loading text-center py-5">
                    <div class="spinner-border text-primus">
                        <span class="visually-hidden">Loadin>
                    </div>
                    <p class="mt-2">Loading data...</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Create/Edit Coup-->
    <div class="mo"-1">
        <divg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="moda
                    <butt>
                </div>
                <div class="mbody">
                    <formorm">
                        <div class="row">
                            <
                         
                  l>
              
  </div>
                           iv>
                            <div class="col-md-6">
                                <div class="mb-3">
              
d>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="
                            <textarea class="form-control" id="couea>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">abel>
                                    <input type="text" class="uired>
                             iv>
                            </div>
                            <">
                             >
                      bel>
                  d>
            div>
                            </div>
                            <div class="col-md-4">
                                <div clas>
                  
            e="5">
                                </div>
                            </div>
                  </div>
            ">
                            <div class="col-md-4">
                                <div -3">
                           l>
                            
                                        <option value="percentage">Percenta
                                        <option>
                                        <o>
                                    </select>
                                </div>
                            </div>
                            <div class="col">
                                <div class
                                    <label cl>
                                    <input ted>
                             >
                            /div>
                            <div class="col-md-4">
                                <div class="mb-3">
                            bel>
                        min="0">
                
                            </div>
                        </div>
                      ow">
                  
              b-3">
          abel>
">
                                </div>
                            </div>
                            <div cl-6">
                                <div c
                                    <label class="form-label">Valid To</la
                                    <input type="datetime-local" class="form-control" o">
                   </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Affiliate L>
                            <input type="url" class="form-control" id="coupon-affiliate-li
                        </
                    ">
                            <label class="fo>
                            <input type="url" class="form-control" idage-url">
                        </div>
                        <d
                    
                            <textarea clas
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                              ">
                                    <input classlusive">
                                    <label class="form-check-label" f>
                                        Exclusive Coupon
                                    </label>
                                </div>
                            </div>
                          6">
                    k">
                                    <input
                                    <label class">
                                        Featured Coupon
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="buttton>
                    <button tybutton>
                </div>
            </div>
        </div>
    </div>

    <!-- Moderation Modal -->
    <div class="modal fade" id"-1">
        <div class="modal-
            <div cla
                <div class="modal-header">
                    <h5 class="modal-title">Mode</h5>
                    <button type="button" class="btn-close btn-close-white" dan>
                </div>
                <div class="mo">
                    <div id="moderation-coupon-d">
                        <!-- Coupon details will be loaded here -->
                    </div>
                    <div class">
                        <l>
                    
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">C>
                    <button ty
                    <button type="button" class=ton>
                    <button type="button" class="btn btn-success" onclick
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bopt>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.dipt>
    <script>
        // Global variables
        let currentCouponId = null;
        let selectedCoupons = Set();
        let currentPage = 1;
        let currentF;

        // Initialize the application
        $(document).ready(function() {
            initializeApp();
        });

        function initializeApp() {
            // Load initial data
            loadDashboardData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Setup naon
            setupN
        }

) {
            // Select allkbox
            $('#select-all-coupons').chan() {
                const isChecked = $
                $('.coupon-checkbox').);
                updateSelectedCoupons();
            });

            // Individual coupon checkboxes
            $(document).on('change', '{
                updateSelectedCoupons();
            });

            // Filter inputs
            $('#filter-sea
        }

        function setupNavigation() {
            $('.sidebar .nav-link').click(function(e) {
                e.preventDefault();
                const section = $(this).data('section');
                showSection(section);
                
                // Uem
                $('.sidebar .nav-link').remo'active');
                $(this).addClass('active');
            });
        }

        function showSection(s
            $('.content-see();
            $(`#${seshow();
            
            switch(section) {
                case 'dashboard':
                    loadDashboard
                    break;
                case 'coupons':
                    loadCouponsDa();
                    break;
                case 'mderation':
                  
              k;
          s':
esData();
            
                case 'analy
                    loadAnalata();
                    break;
            }
        }

        // Dashboard functions
        function loadDashboardData() {
            showLoading();
            
            Promise.all([
                fetch('/api/admin/
            r.json())
 => {
                if (statsData.success) {
                    updateD.data);
                }
            ccess) {
                    up);
                }
                hideLoading();
            }).catch(error => {
            ror);
                hideLoading();
                showAlert('Error loading dashboard data', 'danger');
            ;
        }

        function updateDashboardStats(stats) {
         ;
e);
            $('#pending-coupons').text(ng);
            $('#total-renue));
            
            // Update top stores
            const topStoresHtml = stats.to
                <div class="d-flex
                  pan>
                    <span class="badge>
                </div>
            `)n('');
         ;
  }

        function ons) {
            const tbody = $('#dy');
            tbod);
            
            coupons.forEach(coupon => {
                const row = `
                    <tr>
                >
                        <td>${coupon.store}</td>
                        <td><span class="badge ${getStatusBadgeClass(coupon.sspan></td>
                        <td>${formatDate(coupon.createdAt)}</td>
                d>
                            <button class="btn btn-sm btn
                                <i class="fas fa-edit"></i>
                            </button>
                 </td>
                    </tr>
                `;
                (row);
            });
        }

        // Coupons functions
        function loadCouponsData() {
            showLoading();
            
            consts({
                page: current
                limit: 20,
             tFilters
         });
     
            fetch(`/api/admin/coupons?${}`)
                .then(response => response.json())
                .then(data => {
                    if (data.sccess) {
                       );
             .data);
            se {
                 );
                    }
                g();
                })
                .catch(error => {
                
                    hideLoading();
                    showAlert('Error loading coupons', 'da;
                });
        }

        function ) {
            const tbody = $('
            tbody.empty();
            
         on => {

                    <tr>
                 td>
                            <input type="checkbox" class="coupon-checkbox">
                        </td>
                
                        <td>${coupo
                        <td>${coupon.store}</td>
                 d>
                        <td>$
                        <td><span class="badge ${getStatusBadgtd>
             /td>
         >

                        <td>
                 
                                <button class="btn btn-outlineit">
                                    <i class="fas fa-edit"></i>
                >
                                <button class="btn btn-outline-info" onclic
                                    <i class="fas fa-copy"></i>
                >
                                <button c>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                   r>
                `;
                tbody.append(row);
            });
        }

        function updatePagination(dat{
            const pagination = $('#coupons-pagination');
            mpty();
            
            const totalPages = data.tot
            const currentPage = data.page;
            
            // Previouton
            if (currentPage > 1) {
                pagination.append(`
                    <li class="page-item">
                      
                    </li>
                `);
            }
            
            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(total
                pagination.append(`
                    <l
                        <a class="page-${i}</a>
                    </li>
                `);
            }
            
            button
            if (currentPage < totalPages) {
         d(`

                        <a class="page-link" ha>
                    </li>
            
            }
        }

        // Moderation fctions
        funct
            ng();
            
            fetch('/n')
                .then(reon())
                .then(data => {
                    if (data.success) {
                        u);
                    } else {
                        showAlert('Error loa);
                    }
                    hideng();
                })
                .catch(error => {
                    console.error('Error loading moder);
                    hideLoading();
                    showger');
                });
        }

        function updateMoons) {
            const tbody 
            tbody.empty();
            
            if (coupons.length 0) {
                tbody.app(`
                    <tr>
                        <td colspan="7" class="text-center text-muted">No coupo
                    </tr>
                `);
                return;
            }
            
            coupons.forEach(coupon => {
                const row = `
                    <tr>
                        <td>${coupon.title}</td>
                        <td>${coupon.sto>
                        <td>${coupon.d>
                        <td>${c
                        <td>${coupon.createdBy}</td>
                        <td>${formatDa</td>
                        <td>
                         >
                     
                        ton>
            </td>
                    </tr>
                `;
         row);
    });
        }

        // M
        function showCreateCouponM
            currentCouponId = null;
            $('#couponM;
            $
            ');
        }

        function editCoupon(co) {
            currentCouponId;
            $('#couponModalTitle').text('Edit Coupon');
            
             data
            fetch(`/api/adm}`)
                .then(response => response.json())
                .then(data => {
            
                        populateCouponForm(data.data);
                        $('#couponModal').modal('show');
               } else {
            anger');
                    }
                })
                .catch(error => {
             
            
                });
        }

        function populateCouponFpon) {
            $('#coupon-title').val(coupon.title);
            $('#coupon-code').val(coupon.code);
            $('#coupon-description').val(coupon.description);
         tore);
;
            $('#coupon-priority'ority);
            $('#coupon-discount-type').val(coupon.discountType);
            $('#coupon-discount').val(coupon.discount);
         );
'');
            $('#coupon-valid-to').val
            $('#coupon-affiliate-link').val(coupon.affiliateLink);
            $('#coupon-image-url').val(coupon.imageUrl || '');
            $('#coupon-terms').val(coupon.termsAndConditions || '');
         
tured);
        }

        function saveCoupon() {
            const formData = {
                title: $('#coupon-title').val(),
         (),

                store: $('#coupon-store').val(),
                sow
                category: $('#coupon-category').val(),
                priority: parseInt($('#coupon-prior| 0,
                
                discount: parseFloa|| 0,
                usageLimit: parseInt($('#coupon| 0,
                validFrom: $('#coupon-valid-from').val() ? new Date($('#coupon-valid-f
                validTo: $('#coupon-valid-to
                affiliateLink: $('#coupon-affiliate-link').val(),
                imageUrl null,
                termsAndConditions: $('#coupon-terms').val() || '',
                i
                isFeatured: $
                tags: []
            }

';
            const method = currentCoupo

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
            
                    showAlert(`Coups');
                    refreshData();
             
                    showAlert('Errornger');
                }
            })
         => {
;
                showAlert('Error saving co');
            });
        }

        function showModerationModal(couponId) {
            currentCouponId = couponId;
            
            // Load coupon data for moderation
            fetch(`/api/admin/coupons/${couponId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const coupon = data.data;
                        const detailsHtml = `
                            <div class="card">
              >
            }</h6>
                                    <p class="card-text">${coupon.descripion}</p>
                                    <div class="row">
            
                                            <strong>Store:</strong> <br>
                                            <strong>Category:</strong> 
            code}
                 >
                                        <div c
                                            <strong>Discount:<
                                         <br>
                                            <strong>Source:</strce}
                
                                    </div>
                           /div>
                            </>
                        `;
                      ml);
                        $('#moderation-notes').val('');
                   how');
                 else {
                        showAlert('Error loading cor');
                    }
                })
                .catch(error => {
                    console.error('Error load;
                    showAlert('E);
                });
        }

        function ion) {
            const notes = $('val();
            
            i{
         ;
   return;
            }

            const moder= {
             ,
            tes
            };

            fetch(`/api/admin/coupone`, {
                met
                {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringif
            })
            .then(response => re)
            .then(data => {
                if (data {
                    $('#moderationModal').modal('hide');
                 ss');
                    loadModer;
                    loadDashboardData(); // Refresh dashboard stats
             lse {
         ;
 }
            })
            .catch(error => {
            ror);
                showAlert('Error moderating coupo);
            });
        }

        // Bulk o
        function updateSelectedCoupons() {
            selectedCoupons.clear()
            $('.coupon-checkbo
                selectedCoupons.add($(this).val());
            });
            
            $('#sel);
            
            if (selectedCoupons.size > 0) {
                
            } else {
                $('#bulk-actions-bar').hide()
            }
        }

        function bulkOperation(operation) {
            if (s
                showAlert('Pl
                return;
            }

 {
                return;
            }

            Data = {
                operation: operation,
                couponIds: Array.from(selectedCoupons)
            };

         tion', {
OST',
                headers: {
                    'Content-Type': 'applicationson'
                },
                body
            })
            .
         > {
{
                    const result = data.data;
                    showAlert(`Bulk operation completed: ${result.succe;
            );
                    $('#bu);
                    $('#select-all-coupons').prop('ch
                    refa();
             
            
                }
            })
            .catch(erro{
             ror);
            
            });
        }

        // Fions
        function 
            currentFilters = {};
            
            const status = $(';
            if (status && status.length > 0) {
                curren;
            }
            
            const store = $('#filter-stor);
            if (store) {
                cur store;
            }
            
            consl();
            if (category) {
                currentFilters.category = category;
            }
            
            const search = $('#filter-search').val();
            if (search) {
                currentFilters.search = search;
            }
            
            const();
            if (dateFrom) {
                currentFilters.dateFrom = dateFrom;
            }
         
);
            if (dateTo) {
                currentFilters.dateTo = dateTo;
            }
            
);
            currentFilters.sortOrder =;
            
            currentPage = 1;
            loadCouponsData();
        }

        function clearCouponFilters() {
            $('#filter-status').val([]);
            $('#filter-store').val('');
            $('#filter-category').val('');
            $('#filter-search').val('');
            $('#filter-date-from').val('');
            $('#filter-date-to').val('');
            $('#filter-sort-by').val('createdAt');
            $('#filter-sort-order').val('desc');
            
            cu
             = 1;
            loadCouponsData();
        }

        function changePage(page) {
            currentPage = page;
            loadCouponsData();
        }

        // Utility functions
        funcd) {
            if (!confirm('Are you sure you{
         
       }

            fetch(`/api/admin/coupo{
            OST'
            })
            .then(response => response.json())
            {
                if (data.success) {
                    showAlert('Coupon duplicat');
                    refata();
              } else {
            ');
                }
            })
            .catch(error => {
                console.error('Error duplica);
                showAlert('Error duplicating coupon', 'danger');
            });
        }

        functio) {
             {
                return;
            }

            fetch(`/api/admin/coupons/${couponId}`, {
            ELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) 
                   ;
                ();
                } else {
                nger');
                }
            })
            .catch(error => {
                console.error('Eor);
                showAlert('Error deleting coupon', 'danger');
            });
        }

        function refreshData({
            const activeSection = $('.sidebar .nav-link.active').dat);
            sction);
        }

        function showLoading() {
            $('.l();
        }

        function hideLoading() {
            $('.loading').hide();
        }

        function showAlert(message, type = 'info') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible 
                    ${message}
                
                </div>
            `;
            
            // Remove existing alerts
            $('.alert').remove();
            
            // Add new alert at tntent
            $('.main-content').prepend(alertHtml);
            
            // Auto-dismiss af
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }

        function getStatusBads) {
            switch(status) {
             s';
         ondary';

                case 'expired': return
                case 'rejected': return 'bg-dark';
         ary';
 }
        }

        function formatDate(dateString) {
            return new Date(dateStrin
                year: 'numeric',
                month: 'short',
                dric'
            });
        }

       mber) {
       tml>dy>
</hript>
</bo/sc }
    <
       ata...');cs dalytig ang('Loadine.lool    cons
        ics loadingnt analytmeODO: Imple     // T{
       ata() csDloadAnalytiction fun      }

    ;
      ..')data.mplates ing tead'Losole.log(on     c  ading
     tes loment templaODO: Imple       // T) {
     platesData(adTemion lo  funct   ons
   ectier s othons forctir funPlaceholde   // 

        }};
                 ait);
er, weout(lat = setTim   timeout         
    ut);out(timeoarTime       cle      };
                   (...args);
  func                 imeout);
 ut(tarTimeole  c                  => {
r = () onst late         c {
       on(...args)dFunctiuteon execn functi    retur;
        timeout let            
, wait) {(funcion debouncect      fun     }

     
r);t(numbema).forn-IN'berFormat('ew Intl.Numreturn ne     r(nutNumbemaction for fun'numeay:  {('en-IN',StringaleDate.toLocg)           ondn 'bg-securdefault: ret       anger';-d 'bgg-warning';: return 'be 'pending'        cas        turn 'bg-secve': renacti case 'i       'bg-succesturn': reve 'acticase   tatugeClass(scondster 5 se of main cohe topn>"></butto="alertmissis" data-bs-deos"btn-clss=on" cla="buttbutton type <   "alert">how" role=fade sading').showoctiveSection(ahowSe('section'a) oupon:', errdeleting crror  'daor,.err+ data' upon:  deleting co'Errorrt(    showAlerefreshData    'success')cessfully', eted suc del('CouponAlertowsh { 'Dmethod:    ))e.'ndonbe unot  action canpon? Thisis couto delete thu want sure yo('Are you  (!confirmifouponIdteCoupon(cn delepon:', errorting cou'dangerta.error,  da coupon: ' +ing duplicatlert('Error       showA   reshDccessly', 'suulessf succed=> en(data .thd: 'P  metho  duplicate`, ponId}/ns/${cou     urn;  ret     oupon?')) this cate licant to dup won(couponIplicateCoupn dutiotPageencurrs = {};rrentFilter').val()orderort-'#filter-s $(al(rt-by').vter-so$('#filtBy = Filters.sorent        curr    -to').val(er-date $('#filto =t dateT  cons             ).valdate-from'ilter-= $('#feFrom  datgory').var-catefiltery = $('#t catego =.storeltersrentFi).val(e'')join(',status.us = ats.sttFilters').val()statur-#filtenFilters() {lyCoupoappnctilter fu;, 'danger') operation'bulkming erfor pert('ErrorhowAl    s erperation:',ming bulk oorrror perf('Eror.erconsole   r => nger');rror, 'da+ data.en: ' ulk operatiog b performinrorhowAlert('Er s        {   } elsereshDat false);ecked',e().hid-bar'onslk-actis.clear(tedCouponselec        ccess')`, 'suiled} failedsult.fa, ${reulssfucce sss}success)  if (data.               data =   .then()n()soe.jonsonse => respen(respthkData)uly(bngif: JSON.stri/j  method: 'P              eraulk-opn/coupons/b('/api/admitch   feonst bulkc)?`))n(s couposize}tedCoupons. ${selection}opera want to ${ sure you`Are youirm(nf(!co  if           ing');'warnns first',  couposelectase e{= 0) ze ==sins.lectedCoupoe;;bar').show()ctions-k-a('#bul$upons.sizectedCotext(selecount').ected-function() {ach(ed').ex:check;sperationn', 'danger'upon:', erating coError moderor('console.err                   ')'dangerr,  + data.erron: 'rating couporror modelert('EhowA s             } etionData()ally`, 'succesuccessfuon}d  ${actirt(`Coupon showAle  cess).sucnse.json()spota)rationDaodey(mders: hea',: 'PUTodhd}/moderatntCouponIcurres/${otes: no    nn: action   actiotionData a             ing')warntion', ' for rejecasonide a re'Please provlert(  showA     trim()) !notes.reject' && on === 'tif (actes').tion-no#moderaupon(actmoderateCo 'danger'ing coupon',or loadrr', error)ing coupon:ror, 'dangeer data.pon: ' +u   } l').modal('sderationModa $('#mo    sHttml(detail-details').hponration-cou#mode  $('ivd     <iv>      </d                  oupon.sourong> ${catedBy}n.cre${coupog> :</stron by>Created<strong   '}<br>: 'tage' ? '%'  === 'percenountTypepon.disc{couscount}$ ${coupon.distrong>/l-md-6">s="coasl   </div                    ${coupon.e:</strong> <strong>Cod                                egory}<br>at${coupon.cre}pon.sto${cou-md-6">class="col <div                            title.tcoupond-title">${s="car <h6 clas                       y"rd-bod"caiv class= <d                 , 'dangerupon'', error)upon:ng coError savierror('   console.             catch(error    .data.error, 'da: ' + upon saving co   } else {ucces`, 'successfully'created'} s: d' ? 'updateouponId n ${currentCo);odal('hide'nModal').mupo  $('#co      T';POSPUT' : '? 'nId ns/coupoi/adminap : '/}`ponIdrentCouurons/${cadmin/coup `/api/nId ?potCou= currenst url     con        ;ed'),s(':check.ired')upon-featu('#cod'),ke:chece').is('exclusivcoupon-'#lusive: $(sExc').val() ||-urlupon-image: $('#co()) : null,o').val-tlidon-vae($('#coup ? new Dat').val(), : nullom').val())r()) |allimit').v-usage-()) nt').valoupon-discou#c($('tal(),pe').vunt-ty-disco $('#couponntType:discouval()) |).ity' nD forme as I store nang Usi.val(), //pon-store')$('#coutoreId: ),n').val(tioscrip'#coupon-deption: $(escri d               e').valupon-cod('#co $e:    cod   easF', coupon.i('checkeded').propon-featur  $('#coup          e);lusivisExcupon.', co'checked.prop(lusive')xc#coupon-e   $(''); : '0, 16).slice(SOString()To).toIoupon.valid? new Date(cn.validTo (coupo : 16)ice(0, tring().sloISOSrom).t.validFpone(coum ? new DatlidFroon.vaupcol(.va-from')on-valid$('#coup            n.usageLimital(coupo).v-limit'n-usage#coupo('  $ oupon.prial(c).vgory)oupon.catery').val(coupon-catego('#c $           l(coupon.svare').-sto$('#coupon   orm(cou 'danger');',ing coupon'Error load showAlert(       rror);coupon:', eror loading .error('Erle    conso   rror, 'd.eata + don: 'oup loading cort('ErrhowAler         s         {.success)dataf (     i   ponIdupons/${coucoin/Load coupon// uponId = couponIdowshdal('mol').Moda'#coupon$(].reset();Form')[0('#couponupon')te New Co('Creale').textodalTit() {odall functionsoda        append(ody.tb                   ut  </b  oderatei>Mme-1"></avel as fa-g="f class    <i       }')"{coupon.idodal('$rationMhowModeclick="simary" on-prbtn-sm btntn  class="button   <batedAt)}pon.crete(cou'}</td> : '%'? 'e' = 'percentagype ==n.discountTt}${coupoon.discounoup</ttegory}care}</tdd>oderation</t mndingpens end=== tbody');table eration-= $('#modonTable(coupderatiata', 'danration dloading moderor Alert('Erdata:', erroration Loadi 'danger'.error, + dataion data: ' moderatdingataable(data.dationTderpdateMoponse.jsonse => ressptiomoderaending-/coupons/pdminapi/aadishowLoata() {nDeratioadModloion un;    `)1})">Next</entPage + (${currgePagek="channclic oef="#"rtem">ss="page-ili cla     <               appen pagination.      // Next i})">ge(${Pack="changeclionref="#" link" h}">ive' : ''ge ? 'actPa === currentem ${i"page-it class=i) {+ 2); i++age rrentPPages, cua>revious</- 1})">PntPage (${curreangePageonclick="chef="#" -link" hrass="pagecl  <a s butages;alPon.epaginatia)  </tete"title="Del" }')n.idpon('${coupo"deleteCou" onclick=nger-danen-outli"btn btlass=   </button             cate">lile="Dup" titupon.id}')upon('${coplicateCok="dubutton        </        "Ed}')" title=on.id'${coupditCoupon(k="e" onclicrimary-p>sm"up-grogroup btn-"btn- <div class=          d>t)}</tdApon.createtDate(cou{forma       <td>$                 )}</tduecoupon.revenormatNumber(${f  <td>₹             nt}<ckCoupon.cli>${cou      <td     ></s}</spann.statu">${coupos)}oupon.statu(csseCla/td>'%' : ''}<e' ? rcentag 'peype ===iscountTupon.dunt}${cocoupon.disco{egory}</tpon.cat <td>${cou      n.code}</td>/td>itle}<{coupon.t  <td>$      {coupon.id}" value="$       < `w =onst ro           c     uph(corEacons.fo.coup data  ble tbody');ns-ta#coupotasTable(daponpdateCouunger'), error); coupons:'ror loadingerror('Ere.onsol c   adin   hideLo r'ngeda.error, 'ata ' + ding coupons:'Error loadt(   showAler          } el  taation(da updatePagin          datasTable(data.pdateCoupon uuparams           ...curren  e,PagaramchPLSearw UR= ne params ndtbody.appe       d}')">oupon.i${cCoupon('ck="editary" oncliline-prim-out        <t.status}</oncoup">${tatus)}}</tditle${coupon.t <td>       pty(y.emble tbocoupons-tarecent-ns(coupeRecentCoupoupdat      ml)esHtor.html(topStres-list')sto'#top-$(   .joiue)}</spanevener(store.ratNumborm{fmary">₹$ bg-pri</sre}ore.sto{st  <span>$">center mb-2ign-items--between alntstify-conte juore => `stp(s.mapStoreotalReveer(stats.t formatNumb +ext('₹'').tenuevts.pendistaats.activs').text(stouponve-c('#acti  $          tal)tats.toext(soupons').tl-c   $('#tota})ata:', erboard doading dashError lole.error('ons    consata.coupcentData.dpons(reteRecentCoudaata.su(recentD    if Dataats(statsoardStashbentData]), recData(([stats).then   ]         r =>desc').then(sortOrder=reatedAt&=10&sortBy=cmit/coupons?lidminch('/api/a    fet on()),(r => r.js).thens/stats'uponco);
        });

        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('input', debounce(searchCoupons, 500));
            
            // Filters
            document.getElementById('storeFilter').addEventListener('change', loadCoupons);
            document.getElementById('statusFilter').addEventListener('change', loadCoupons);
            document.getElementById('activeFilter').addEventListener('change', loadCoupons);
            
            // Select all checkbox
            document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
            
            // Form submissions
            document.getElementById('couponForm').addEventListener('submit', saveCoupon);
            document.getElementById('importForm').addEventListener('submit', importCoupons);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function loadCoupons(page = 1) {
            try {
                showLoading();
                
                const params = new URLSearchParams({
                    page: page.toString(),
                    limit: '20'
                });
                
                const store = document.getElementById('storeFilter').value;
                const status = document.getElementById('statusFilter').value;
                const isActive = document.getElementById('activeFilter').value;
                
                if (store) params.append('store', store);
                if (status) params.append('status', status);
                if (isActive) params.append('isActive', isActive);
                
                const response = await fetch(`/api/admin/coupons?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    renderCouponsTable(data.data.coupons);
                    renderPagination(data.data.page, data.data.totalPages, data.data.total);
                    currentPage = data.data.page;
                    totalPages = data.data.totalPages;
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Failed to load coupons: ' + error.message);
            }
        }

        async function searchCoupons() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                loadCoupons();
                return;
            }
            
            try {
                showLoading();
                
                const response = await fetch(`/api/admin/coupons/search?q=${encodeURIComponent(searchTerm)}&page=1&limit=20`);
                const data = await response.json();
                
                if (data.success) {
                    renderCouponsTable(data.data.coupons);
                    renderPagination(data.data.page, data.data.totalPages, data.data.total);
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Failed to search coupons: ' + error.message);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/admin/coupons/stats');
                const data = await response.json();
                
                if (data.success) {
                    renderStats(data.data);
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadStores() {
            try {
                // This would typically come from a stores API
                const stores = ['Amazon', 'Flipkart', 'Myntra', 'Zomato', 'Swiggy', 'BookMyShow'];
                
                const storeFilter = document.getElementById('storeFilter');
                const couponStore = document.getElementById('couponStore');
                
                stores.forEach(store => {
                    const option1 = new Option(store, store);
                    const option2 = new Option(store, store);
                    storeFilter.appendChild(option1);
                    couponStore.appendChild(option2);
                });
            } catch (error) {
                console.error('Failed to load stores:', error);
            }
        }

        function renderStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalCoupons || 0}</div>
                    <div class="stat-label">Total Coupons</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.activeCoupons || 0}</div>
                    <div class="stat-label">Active Coupons</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.pendingCoupons || 0}</div>
                    <div class="stat-label">Pending Approval</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalUsage || 0}</div>
                    <div class="stat-label">Total Usage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">₹${(stats.totalSavings || 0).toLocaleString()}</div>
                    <div class="stat-label">Total Savings</div>
                </div>
            `;
            
            statsGrid.innerHTML = statsHtml;
        }

        function renderCouponsTable(coupons) {
            const tbody = document.getElementById('couponsTableBody');
            
            if (coupons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No coupons found</td></tr>';
                hideLoading();
                return;
            }
            
            const html = coupons.map(coupon => `
                <tr>
                    <td>
                        <input type="checkbox" class="coupon-checkbox" value="${coupon.id}" 
                               onchange="toggleCouponSelection('${coupon.id}')">
                    </td>
                    <td><code>${coupon.code || 'N/A'}</code></td>
                    <td>${coupon.title}</td>
                    <td>${coupon.store}</td>
                    <td>
                        ${coupon.discountType === 'percentage' ? 
                          `${coupon.discountValue}%` : 
                          `₹${coupon.discountValue}`}
                    </td>
                    <td>
                        <span class="status-badge status-${coupon.status}">
                            ${coupon.status.charAt(0).toUpperCase() + coupon.status.slice(1)}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${coupon.isActive ? 'active-badge' : 'inactive-badge'}">
                            ${coupon.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${coupon.usageCount || 0}${coupon.usageLimit ? `/${coupon.usageLimit}` : ''}</td>
                    <td>${new Date(coupon.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editCoupon('${coupon.id}')">
                            ✏️ Edit
                        </button>
                        ${coupon.status === 'pending' ? `
                            <button class="btn btn-success btn-sm" onclick="moderateCoupon('${coupon.id}', 'approve')">
                                ✅ Approve
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="moderateCoupon('${coupon.id}', 'reject')">
                                ❌ Reject
                            </button>
                        ` : ''}
                        <button class="btn btn-danger btn-sm" onclick="deleteCoupon('${coupon.id}')">
                            🗑️ Delete
                        </button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            hideLoading();
        }

        function renderPagination(page, totalPages, total) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = `<span>Total: ${total} coupons</span>`;
                return;
            }
            
            let html = `<span>Total: ${total} coupons</span>`;
            
            // Previous button
            if (page > 1) {
                html += `<button onclick="loadCoupons(${page - 1})">Previous</button>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(totalPages, page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === page ? 'active' : ''}" onclick="loadCoupons(${i})">${i}</button>`;
            }
            
            // Next button
            if (page < totalPages) {
                html += `<button onclick="loadCoupons(${page + 1})">Next</button>`;
            }
            
            pagination.innerHTML = html;
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        function openCreateModal() {
            editingCouponId = null;
            document.getElementById('modalTitle').textContent = 'Create Coupon';
            document.getElementById('couponForm').reset();
            document.getElementById('couponModal').style.display = 'block';
        }

        async function editCoupon(couponId) {
            try {
                const response = await fetch(`/api/admin/coupons/${couponId}`);
                const data = await response.json();
                
                if (data.success) {
                    editingCouponId = couponId;
                    document.getElementById('modalTitle').textContent = 'Edit Coupon';
                    populateForm(data.data);
                    document.getElementById('couponModal').style.display = 'block';
                } else {
                    alert('Failed to load coupon: ' + data.error);
                }
            } catch (error) {
                alert('Failed to load coupon: ' + error.message);
            }
        }

        function populateForm(coupon) {
            document.getElementById('couponTitle').value = coupon.title || '';
            document.getElementById('couponDescription').value = coupon.description || '';
            document.getElementById('couponCode').value = coupon.code || '';
            document.getElementById('couponStore').value = coupon.store || '';
            document.getElementById('couponCategory').value = coupon.category || 'general';
            document.getElementById('discountType').value = coupon.discountType || 'percentage';
            document.getElementById('discountValue').value = coupon.discountValue || '';
            document.getElementById('minimumAmount').value = coupon.minimumAmount || '';
            document.getElementById('maximumDiscount').value = coupon.maximumDiscount || '';
            document.getElementById('usageLimit').value = coupon.usageLimit || '';
            document.getElementById('couponTags').value = coupon.tags ? coupon.tags.join(', ') : '';
            
            if (coupon.validFrom) {
                document.getElementById('validFrom').value = new Date(coupon.validFrom).toISOString().slice(0, 16);
            }
            if (coupon.validUntil) {
                document.getElementById('validUntil').value = new Date(coupon.validUntil).toISOString().slice(0, 16);
            }
        }

        async function saveCoupon(event) {
            event.preventDefault();
            
            const formData = {
                title: document.getElementById('couponTitle').value,
                description: document.getElementById('couponDescription').value,
                code: document.getElementById('couponCode').value || undefined,
                store: document.getElementById('couponStore').value,
                category: document.getElementById('couponCategory').value,
                discountType: document.getElementById('discountType').value,
                discountValue: parseFloat(document.getElementById('discountValue').value),
                minimumAmount: parseFloat(document.getElementById('minimumAmount').value) || undefined,
                maximumDiscount: parseFloat(document.getElementById('maximumDiscount').value) || undefined,
                usageLimit: parseInt(document.getElementById('usageLimit').value) || undefined,
                tags: document.getElementById('couponTags').value.split(',').map(t => t.trim()).filter(t => t)
            };
            
            const validFrom = document.getElementById('validFrom').value;
            const validUntil = document.getElementById('validUntil').value;
            
            if (validFrom) formData.validFrom = new Date(validFrom);
            if (validUntil) formData.validUntil = new Date(validUntil);
            
            try {
                const url = editingCouponId ? 
                    `/api/admin/coupons/${editingCouponId}` : 
                    '/api/admin/coupons';
                const method = editingCouponId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('couponModal');
                    loadCoupons(currentPage);
                    loadStats();
                    alert(data.message);
                } else {
                    alert('Failed to save coupon: ' + data.error);
                }
            } catch (error) {
                alert('Failed to save coupon: ' + error.message);
            }
        }

        async function deleteCoupon(couponId) {
            if (!confirm('Are you sure you want to delete this coupon?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/coupons/${couponId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadCoupons(currentPage);
                    loadStats();
                    alert(data.message);
                } else {
                    alert('Failed to delete coupon: ' + data.error);
                }
            } catch (error) {
                alert('Failed to delete coupon: ' + error.message);
            }
        }

        async function moderateCoupon(couponId, action) {
            const reason = action === 'reject' ? prompt('Reason for rejection:') : undefined;
            
            if (action === 'reject' && !reason) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/coupons/${couponId}/moderate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action, reason })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadCoupons(currentPage);
                    loadStats();
                    alert(data.message);
                } else {
                    alert('Failed to moderate coupon: ' + data.error);
                }
            } catch (error) {
                alert('Failed to moderate coupon: ' + error.message);
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.coupon-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                toggleCouponSelection(checkbox.value);
            });
        }

        function toggleCouponSelection(couponId) {
            if (selectedCoupons.has(couponId)) {
                selectedCoupons.delete(couponId);
            } else {
                selectedCoupons.add(couponId);
            }
        }

        async function performBulkAction() {
            const action = document.getElementById('bulkAction').value;
            
            if (!action) {
                alert('Please select a bulk action');
                return;
            }
            
            if (selectedCoupons.size === 0) {
                alert('Please select coupons to perform bulk action');
                return;
            }
            
            if (!confirm(`Are you sure you want to ${action} ${selectedCoupons.size} coupon(s)?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/coupons/bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        couponIds: Array.from(selectedCoupons),
                        operation: action
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadCoupons(currentPage);
                    loadStats();
                    selectedCoupons.clear();
                    document.getElementById('selectAll').checked = false;
                    document.getElementById('bulkAction').value = '';
                    alert(`Bulk ${action} completed. Success: ${data.data.success}, Failed: ${data.data.failed}`);
                } else {
                    alert('Failed to perform bulk action: ' + data.error);
                }
            } catch (error) {
                alert('Failed to perform bulk action: ' + error.message);
            }
        }

        function openImportModal() {
            document.getElementById('importModal').style.display = 'block';
            setupFieldMapping();
        }

        function setupFieldMapping() {
            const fieldMapping = document.getElementById('fieldMapping');
            const fields = [
                { key: 'title', label: 'Title' },
                { key: 'description', label: 'Description' },
                { key: 'code', label: 'Code' },
                { key: 'store', label: 'Store' },
                { key: 'category', label: 'Category' },
                { key: 'discountType', label: 'Discount Type' },
                { key: 'discountValue', label: 'Discount Value' },
                { key: 'minimumAmount', label: 'Minimum Amount' },
                { key: 'maximumDiscount', label: 'Maximum Discount' },
                { key: 'validFrom', label: 'Valid From' },
                { key: 'validUntil', label: 'Valid Until' },
                { key: 'usageLimit', label: 'Usage Limit' },
                { key: 'tags', label: 'Tags' }
            ];
            
            const html = fields.map(field => `
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">${field.label}</label>
                        <input type="text" class="form-control" name="mapping_${field.key}" 
                               placeholder="Column name in your file">
                    </div>
                </div>
            `).join('');
            
            fieldMapping.innerHTML = html;
        }

        async function importCoupons(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('importFile');
            const fileType = document.getElementById('fileType').value;
            
            if (!fileInput.files[0]) {
                alert('Please select a file');
                return;
            }
            
            // Collect field mapping
            const fieldMapping = {};
            const mappingInputs = document.querySelectorAll('[name^="mapping_"]');
            mappingInputs.forEach(input => {
                const fieldKey = input.name.replace('mapping_', '');
                if (input.value.trim()) {
                    fieldMapping[fieldKey] = input.value.trim();
                }
            });
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('fileType', fileType);
            formData.append('fieldMapping', JSON.stringify(fieldMapping));
            
            try {
                const response = await fetch('/api/admin/coupons/import', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('importModal');
                    loadCoupons(currentPage);
                    loadStats();
                    alert(`Import completed. Success: ${data.data.success}, Failed: ${data.data.failed}`);
                } else {
                    alert('Failed to import coupons: ' + data.error);
                }
            } catch (error) {
                alert('Failed to import coupons: ' + error.message);
            }
        }

        async function exportCoupons() {
            try {
                const params = new URLSearchParams();
                
                const store = document.getElementById('storeFilter').value;
                const status = document.getElementById('statusFilter').value;
                const isActive = document.getElementById('activeFilter').value;
                
                if (store) params.append('store', store);
                if (status) params.append('status', status);
                if (isActive) params.append('isActive', isActive);
                params.append('format', 'csv');
                
                const response = await fetch(`/api/admin/coupons/export?${params}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `coupons-export-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to export coupons');
                }
            } catch (error) {
                alert('Failed to export coupons: ' + error.message);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>